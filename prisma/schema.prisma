// Prisma schema for Liphant 2.0
// Shadow teacher booking platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  parent
  teacher
  center_admin
  admin // Liphant operations team
}

enum BookingStatus {
  pending
  confirmed
  completed
  cancelled
}

enum Specialization {
  adhd
  autism
  speech
  occupational
  behavioral
  learning
  sensory
  developmental
  social
  other
}

enum PreferredLanguage {
  ar
  en
}

// Admin-related enums
enum ApplicationStatus {
  pending
  approved
  rejected
}

enum ModerationAction {
  approved
  rejected
  flagged
}

// Community-related enums
enum EventCategory {
  playdate
  support_group
  workshop
  social
}

enum EventStatus {
  upcoming
  ongoing
  completed
  cancelled
}

enum RSVPStatus {
  going
  maybe
  not_going
}

// Main user model - linked to NextAuth
model User {
  id                String            @id @default(cuid())
  email             String            @unique
  emailVerified     DateTime?         @map("email_verified")
  password          String?           // For credentials auth
  fullName          String            @map("full_name")
  phone             String?
  avatarUrl         String?           @map("avatar_url")
  role              UserRole          @default(parent)
  preferredLanguage PreferredLanguage @default(en) @map("preferred_language")
  isSuspended       Boolean           @default(false) @map("is_suspended")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  // Role-specific profiles
  parentProfile  ParentProfile?
  teacherProfile TeacherProfile?
  centerProfile  CenterProfile?

  // Bookings (as parent or teacher)
  bookingsAsParent  Booking[] @relation("ParentBookings")
  bookingsAsTeacher Booking[] @relation("TeacherBookings")

  // Reviews
  reviewsGiven    Review[] @relation("ReviewsGiven")
  reviewsReceived Review[] @relation("ReviewsReceived")

  // Conversations
  conversationsAsParent  Conversation[] @relation("ParentConversations")
  conversationsAsTeacher Conversation[] @relation("TeacherConversations")

  // Messages sent
  messagesSent Message[]

  // Admin relations
  applicationsSubmitted TeacherApplication[] @relation("ApplicationSubmitter")
  applicationsReviewed  TeacherApplication[] @relation("ApplicationReviewer")
  reviewModerations     ReviewModeration[]
  suspensionsReceived   UserSuspension[]     @relation("SuspendedUser")
  suspensionsGiven      UserSuspension[]     @relation("SuspensionAdmin")
  unsuspensionsGiven    UserSuspension[]     @relation("UnsuspensionAdmin")
  adminActivityLogs     AdminActivityLog[]

  // Center reviews
  centerReviewsGiven CenterReview[] @relation("CenterReviewsGiven")

  // Community relations
  organizedEvents  Event[]         @relation("EventOrganizer")
  eventAttendances EventAttendee[]
  forumPosts       ForumPost[]     @relation("ForumPostAuthor")
  forumComments    ForumComment[]  @relation("ForumCommentAuthor")

  @@map("users")
}

// NextAuth Account model
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

// NextAuth Session model
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// NextAuth VerificationToken model
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// Parent-specific profile
model ParentProfile {
  id                 String           @id @default(cuid())
  userId             String           @unique @map("user_id")
  childrenCount      Int              @default(0) @map("children_count")
  childrenAges       Int[]            @default([]) @map("children_ages")
  childrenConditions Specialization[] @default([]) @map("children_conditions")
  locationLat        Float?           @map("location_lat")
  locationLng        Float?           @map("location_lng")
  city               String?
  district           String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("parent_profiles")
}

// Teacher-specific profile
model TeacherProfile {
  id              String           @id @default(cuid())
  userId          String           @unique @map("user_id")
  bioEn           String?          @map("bio_en") @db.Text
  bioAr           String?          @map("bio_ar") @db.Text
  specializations Specialization[] @default([])
  experienceYears Int              @default(0) @map("experience_years")
  education       String?
  certifications  Json             @default("[]") // Array of {name, issuer, year, url}
  hourlyRate      Int              @default(0) @map("hourly_rate")
  locationLat     Float?           @map("location_lat")
  locationLng     Float?           @map("location_lng")
  city            String?
  district        String?
  serviceRadiusKm Int              @default(10) @map("service_radius_km")
  isVerified      Boolean          @default(false) @map("is_verified")
  isAvailable     Boolean          @default(true) @map("is_available")
  ratingAvg       Float            @default(0) @map("rating_avg")
  reviewCount     Int              @default(0) @map("review_count")

  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  availabilities    Availability[]
  centerEmployments CenterTeacher[]

  @@map("teacher_profiles")
}

// Teacher availability slots
model Availability {
  id          String  @id @default(cuid())
  teacherId   String  @map("teacher_id")
  dayOfWeek   Int     @map("day_of_week") // 0 = Sunday, 6 = Saturday
  startTime   String  @map("start_time") // HH:MM format
  endTime     String  @map("end_time") // HH:MM format
  isRecurring Boolean @default(true) @map("is_recurring")

  teacher TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@map("availabilities")
}

// Booking model
model Booking {
  id          String        @id @default(cuid())
  parentId    String        @map("parent_id")
  teacherId   String        @map("teacher_id")
  status      BookingStatus @default(pending)
  bookingDate DateTime      @map("booking_date") @db.Date
  startTime   String        @map("start_time") // HH:MM format
  endTime     String        @map("end_time") // HH:MM format
  totalAmount Int           @map("total_amount")
  notes       String?       @db.Text
  createdAt   DateTime      @default(now()) @map("created_at")
  updatedAt   DateTime      @updatedAt @map("updated_at")

  parent  User    @relation("ParentBookings", fields: [parentId], references: [id])
  teacher User    @relation("TeacherBookings", fields: [teacherId], references: [id])
  review  Review?

  @@map("bookings")
}

// Review model
model Review {
  id        String   @id @default(cuid())
  bookingId String   @unique @map("booking_id")
  parentId  String   @map("parent_id")
  teacherId String   @map("teacher_id")
  rating    Int // 1-5
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  isVisible Boolean  @default(true) @map("is_visible")

  booking    Booking           @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  parent     User              @relation("ReviewsGiven", fields: [parentId], references: [id])
  teacher    User              @relation("ReviewsReceived", fields: [teacherId], references: [id])
  moderation ReviewModeration?

  @@map("reviews")
}

// Conversation model for messaging
model Conversation {
  id            String   @id @default(cuid())
  parentId      String   @map("parent_id")
  teacherId     String   @map("teacher_id")
  lastMessageAt DateTime @default(now()) @map("last_message_at")
  createdAt     DateTime @default(now()) @map("created_at")

  parent   User      @relation("ParentConversations", fields: [parentId], references: [id])
  teacher  User      @relation("TeacherConversations", fields: [teacherId], references: [id])
  messages Message[]

  @@unique([parentId, teacherId])
  @@map("conversations")
}

// Message model
model Message {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  senderId       String   @map("sender_id")
  content        String   @db.Text
  messageType    String   @default("text") @map("message_type") // text, image, voice
  isRead         Boolean  @default(false) @map("is_read")
  createdAt      DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id])

  @@map("messages")
}

// ============================================
// CENTER PROFILE MODELS
// ============================================

// Center/Organization profile
model CenterProfile {
  id              String           @id @default(cuid())
  userId          String           @unique @map("user_id")
  nameEn          String           @map("name_en")
  nameAr          String?          @map("name_ar")
  descriptionEn   String?          @map("description_en") @db.Text
  descriptionAr   String?          @map("description_ar") @db.Text
  specializations Specialization[] @default([])
  servicesOffered Json             @default("[]") // [{nameEn, nameAr, price, duration}]
  logoUrl         String?          @map("logo_url")
  coverImageUrl   String?          @map("cover_image_url")
  locationLat     Float?           @map("location_lat")
  locationLng     Float?           @map("location_lng")
  city            String?
  district        String?
  address         String?          @db.Text
  phone           String?
  email           String?
  website         String?
  operatingHours  Json             @default("{}") // {day: {open, close}}
  isVerified      Boolean          @default(false) @map("is_verified")
  isActive        Boolean          @default(true) @map("is_active")
  ratingAvg       Float            @default(0) @map("rating_avg")
  reviewCount     Int              @default(0) @map("review_count")
  foundedYear     Int?             @map("founded_year")
  licenseNumber   String?          @map("license_number")
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  centerTeachers CenterTeacher[]
  centerReviews  CenterReview[]

  @@map("center_profiles")
}

// Junction table for Center-Teacher relationship
model CenterTeacher {
  id                String   @id @default(cuid())
  centerId          String   @map("center_id")
  teacherId         String   @map("teacher_id")
  role              String   @default("staff") // staff, manager, lead
  employmentType    String   @default("full_time") @map("employment_type") // full_time, part_time, contract
  startDate         DateTime @default(now()) @map("start_date")
  endDate           DateTime? @map("end_date")
  isActive          Boolean  @default(true) @map("is_active")
  canManageBookings Boolean  @default(false) @map("can_manage_bookings")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  center  CenterProfile  @relation(fields: [centerId], references: [id], onDelete: Cascade)
  teacher TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@unique([centerId, teacherId])
  @@map("center_teachers")
}

// Center-specific reviews
model CenterReview {
  id        String   @id @default(cuid())
  centerId  String   @map("center_id")
  parentId  String   @map("parent_id")
  rating    Int // 1-5
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  isVisible Boolean  @default(true) @map("is_visible")

  center CenterProfile @relation(fields: [centerId], references: [id], onDelete: Cascade)
  parent User          @relation("CenterReviewsGiven", fields: [parentId], references: [id])

  @@unique([centerId, parentId])
  @@map("center_reviews")
}

// ============================================
// ADMIN MODELS
// ============================================

// Teacher verification application
model TeacherApplication {
  id           String            @id @default(cuid())
  userId       String            @map("user_id")
  status       ApplicationStatus @default(pending)
  documents    Json              @default("[]") // [{type, url, name}]
  submittedAt  DateTime          @default(now()) @map("submitted_at")
  reviewedAt   DateTime?         @map("reviewed_at")
  reviewedById String?           @map("reviewed_by_id")
  reviewNotes  String?           @map("review_notes") @db.Text

  user       User  @relation("ApplicationSubmitter", fields: [userId], references: [id], onDelete: Cascade)
  reviewedBy User? @relation("ApplicationReviewer", fields: [reviewedById], references: [id])

  @@map("teacher_applications")
}

// Review moderation tracking
model ReviewModeration {
  id            String           @id @default(cuid())
  reviewId      String           @unique @map("review_id")
  action        ModerationAction
  reason        String?          @db.Text
  moderatedAt   DateTime         @default(now()) @map("moderated_at")
  moderatedById String           @map("moderated_by_id")

  review      Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  moderatedBy User   @relation(fields: [moderatedById], references: [id])

  @@map("review_moderations")
}

// User suspension history
model UserSuspension {
  id              String    @id @default(cuid())
  userId          String    @map("user_id")
  reason          String    @db.Text
  suspendedAt     DateTime  @default(now()) @map("suspended_at")
  suspendedById   String    @map("suspended_by_id")
  unsuspendedAt   DateTime? @map("unsuspended_at")
  unsuspendedById String?   @map("unsuspended_by_id")

  user          User  @relation("SuspendedUser", fields: [userId], references: [id], onDelete: Cascade)
  suspendedBy   User  @relation("SuspensionAdmin", fields: [suspendedById], references: [id])
  unsuspendedBy User? @relation("UnsuspensionAdmin", fields: [unsuspendedById], references: [id])

  @@map("user_suspensions")
}

// Admin activity audit log
model AdminActivityLog {
  id         String   @id @default(cuid())
  adminId    String   @map("admin_id")
  action     String // e.g., "review_moderation", "user_suspension"
  targetType String   @map("target_type") // e.g., "review", "user"
  targetId   String   @map("target_id")
  details    Json     @default("{}")
  createdAt  DateTime @default(now()) @map("created_at")

  admin User @relation(fields: [adminId], references: [id])

  @@map("admin_activity_logs")
}

// ============================================
// COMMUNITY MODELS
// ============================================

// Community events
model Event {
  id           String        @id @default(cuid())
  organizerId  String        @map("organizer_id")
  title        String
  description  String        @db.Text
  category     EventCategory
  status       EventStatus   @default(upcoming)
  startDate    DateTime      @map("start_date")
  endDate      DateTime?     @map("end_date")
  locationName String        @map("location_name")
  address      String?
  city         String
  district     String?
  locationLat  Float?        @map("location_lat")
  locationLng  Float?        @map("location_lng")
  isOnline     Boolean       @default(false) @map("is_online")
  onlineLink   String?       @map("online_link")
  maxAttendees Int?          @map("max_attendees")
  imageUrl     String?       @map("image_url")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  organizer User            @relation("EventOrganizer", fields: [organizerId], references: [id])
  attendees EventAttendee[]

  @@map("events")
}

// Event attendance/RSVP
model EventAttendee {
  id        String     @id @default(cuid())
  eventId   String     @map("event_id")
  userId    String     @map("user_id")
  status    RSVPStatus @default(going)
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_attendees")
}

// Forum categories
model ForumCategory {
  id          String   @id @default(cuid())
  name        String
  nameAr      String?  @map("name_ar")
  slug        String   @unique
  description String?
  icon        String? // Lucide icon name
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  posts ForumPost[]

  @@map("forum_categories")
}

// Forum posts/threads
model ForumPost {
  id         String   @id @default(cuid())
  categoryId String   @map("category_id")
  authorId   String   @map("author_id")
  title      String
  content    String   @db.Text
  isPinned   Boolean  @default(false) @map("is_pinned")
  isLocked   Boolean  @default(false) @map("is_locked")
  viewCount  Int      @default(0) @map("view_count")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  category ForumCategory  @relation(fields: [categoryId], references: [id])
  author   User           @relation("ForumPostAuthor", fields: [authorId], references: [id])
  comments ForumComment[]

  @@map("forum_posts")
}

// Forum comments/replies
model ForumComment {
  id        String   @id @default(cuid())
  postId    String   @map("post_id")
  authorId  String   @map("author_id")
  parentId  String?  @map("parent_id") // For nested replies
  content   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  post    ForumPost      @relation(fields: [postId], references: [id], onDelete: Cascade)
  author  User           @relation("ForumCommentAuthor", fields: [authorId], references: [id])
  parent  ForumComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies ForumComment[] @relation("CommentReplies")

  @@map("forum_comments")
}
